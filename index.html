<!doctype html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game SOS Multiplayer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            --board-bg-page: #f0f8ff;
            --cell-content-bg: #ffffff;
            --grid-lines-color: #333333;
            --cell-number-color: #b0b0b0;
            
            --player1-color-text: #007bff; 
            --player1-color-line: #0056b3; 
            
            --player2-color-text: #d93025;  
            --player2-color-line: #b21b10; 

            --score-bubble-p1-bg: #007bff;
            --score-bubble-p2-bg: #d93025;
            --score-text-color: #ffffff;
            
            --vs-text-color: #555555;
            --text-dark: #333333;
            --text-light: #ffffff;
            
            --button-choice-bg: #ffffff;
            --button-choice-border: #cccccc; 
            --button-choice-text-color: #555555; 

            --label-sos-text: #007bff;
            --label-sos-border: #007bff;

            --last-move-highlight-bg: #fff352; 

            --admin-button-bg: #6c757d;
            --admin-button-hover-bg: #5a6268;

            --shadow-light: rgba(0, 0, 0, 0.08);
            --grid-gap: 3px; 
            --button-action-green: #4CAF50;
            --button-action-green-hover: #45a049;

            --button-s-active-bg: var(--player1-color-text);
            --button-s-active-border: var(--player1-color-line);
            --button-o-active-bg: var(--player2-color-text);
            --button-o-active-border: var(--player2-color-line);
            --button-active-text-color: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: var(--board-bg-page);
            color: var(--text-dark);
            padding: 15px;
        }

        .section-container {
            width: 100%; max-width: 480px; background-color: #fff;
            padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-container h2 { margin-bottom: 15px; text-align: center; }
        .section-container input[type="text"] {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border: 1px solid #ccc; border-radius: 4px; font-size: 1em;
        }
        .section-container button {
            width: 100%; padding: 10px 15px; font-size: 1em; cursor: pointer;
            background-color: var(--admin-button-bg); color: white;
            border: none; border-radius: 4px; margin-top: 5px;
        }
        .section-container button:hover { background-color: var(--admin-button-hover-bg); }
        .section-container button.action-green { background-color: var(--button-action-green); }
        .section-container button.action-green:hover { background-color: var(--button-action-green-hover); }
        .section-container button:disabled { background-color: #ccc; cursor: not-allowed; }
        #availableGames { margin-top: 0px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; display: none; background-color: #f9f9f9; }
        #availableGames ul { list-style-type: none; padding: 0; margin: 0; }
        #availableGames li { padding: 8px 5px; border-bottom: 1px solid #e0e0e0; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        #availableGames li:last-child { border-bottom: none; }
        .join-lobby-btn { background-color: var(--button-action-green) !important; color: white !important; padding: 4px 8px !important; font-size: 0.85em !important; margin-left: 10px !important; border-radius: 3px !important; border: none !important; cursor: pointer !important; width: auto !important; margin-top: 0 !important; }
        .join-lobby-btn:hover { background-color: var(--button-action-green-hover) !important; }

        .score-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 480px;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        .player-score { display: flex; align-items: center; font-weight: 600; font-size: 0.9em; }
        .player-score .name { margin: 0 8px; }
        .player-score .score-bubble { width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--score-text-color); font-weight: 700; font-size: 1.1em; }
        .player-score.blue .name { color: var(--player1-color-text); }
        .player-score.blue .score-bubble { background-color: var(--score-bubble-p1-bg); }
        .player-score.red .name { color: var(--player2-color-text); }
        .player-score.red .score-bubble { background-color: var(--score-bubble-p2-bg); }
        .vs-separator { font-weight: 700; font-size: 1.2em; color: var(--vs-text-color); }

        #gameIdDisplay {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--text-dark);
            font-size: 0.9em;
        }
        #messages {
            text-align: center;
            font-weight: 500;
            min-height: 1.2em;
            margin-bottom: 10px;
            width: 100%;
            max-width: 480px;
        }
        #messages.hidden-info { display: none !important; }

        .board-area {
            position: relative; 
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 480px;
            min-width: 300px;
        }
        .board-container { 
            position: relative; 
            display: grid;
            gap: var(--grid-gap);
            background-color: var(--grid-lines-color);
            border: 5px solid var(--grid-lines-color);
            box-shadow: 0 2px 8px var(--shadow-light);
            width: 100%;
            aspect-ratio: 1 / 1;
        }
        .board-cell { background-color: var(--cell-content-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; transition: background-color 0.2s; color: var(--cell-number-color); -webkit-user-select: none; -ms-user-select: none; user-select: none; }
        .board-cell.last-move-highlight { background-color: var(--last-move-highlight-bg) !important; }
        .board-cell.player1-text { color: var(--player1-color-text) !important; }
        .board-cell.player2-text { color: var(--player2-color-text) !important; }
        .board-cell.filled { cursor: default; }
        .board-cell:hover:not(.filled) { background-color: #f0f0f0; }

        .line-overlay { position: absolute; pointer-events: none; }
        .line-overlay line { stroke-linecap: round; }

        #turnInfoDisplay { text-align: center; font-weight: 600; margin-top:15px; font-size: 1em; color: var(--vs-text-color); min-height: 1.2em; }

        .game-controls-bottom { display: flex; justify-content: center; align-items: center; width: 100%; max-width: 480px; padding: 20px 0; gap: 20px; margin-top: 10px; }
        .label-sos { font-size: 0.9em; font-weight: 700; color: var(--label-sos-text); border: 2px solid var(--label-sos-border); padding: 6px 12px; border-radius: 18px; text-transform: uppercase; }
        .letter-buttons-bottom { display: flex; gap: 15px; }
        
        .letter-btn-bottom {
            font-family: 'Poppins', sans-serif; font-size: 1.8em; font-weight: 600;
            width: 60px; height: 60px; border: 2px solid var(--button-choice-border);
            border-radius: 50%; cursor: pointer; color: var(--button-choice-text-color);
            background-color: var(--button-choice-bg); display: flex;
            justify-content: center; align-items: center;
            transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s, color 0.2s;
        }
        .letter-btn-bottom:hover:not(.active) { border-color: #a0a0a0; }
        
        .letter-btn-bottom[data-letter="S"].active {
            background-color: var(--button-s-active-bg); 
            border-color: var(--button-s-active-border); 
            color: var(--button-active-text-color);
            box-shadow: 0 0 8px var(--button-s-active-bg); 
        }

        .letter-btn-bottom[data-letter="O"].active {
            background-color: var(--button-o-active-bg);
            border-color: var(--button-o-active-border);
            color: var(--button-active-text-color);
            box-shadow: 0 0 8px var(--button-o-active-bg);
        }

        .admin-controls { margin-top: 15px; display: flex; gap: 15px; justify-content: center; align-items: center; width: 100%; max-width: 480px; }
        #resetGame, #leaveGameBtn { font-family: 'Poppins', sans-serif; font-size: 0.9em; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: var(--text-light); transition: background-color 0.3s; }
        #resetGame { background-color: var(--admin-button-bg); }
        #resetGame:hover { background-color: var(--admin-button-hover-bg); }
        #leaveGameBtn { background-color: #d9534f; }
        #leaveGameBtn:hover { background-color: #c9302c; }
    </style>
</head>
<body>
    <div id="loginSection" class="section-container">
        <h2>Game SOS Multiplayer</h2>
        <input type="text" id="playerNameInput" placeholder="Masukkan Nama Anda">
        <button id="showAvailableGamesBtn" class="action-green" style="margin-bottom: 10px;">Lihat Game Tersedia</button>
        <div id="availableGames">
            <p><i>Memuat game... (atau tidak ada game)</i></p>
        </div>
        <input type="text" id="gameIdInput" placeholder="Masukkan ID Game (jika bergabung)">
        <button id="joinOrCreateGameBtn" class="action-green">Gabung / Buat Game Baru</button>
    </div>

    <div id="gameSection" style="display:none; flex-direction: column; align-items: center; width:100%;">
        <div class="score-bar">
            <div class="player-score blue"> <span class="name" id="player1NameDisplay">Pemain 1</span>
                <div class="score-bubble" id="scoreP1Display">0</div>
            </div>
            <div class="vs-separator">VS</div>
            <div class="player-score red">
                <div class="score-bubble" id="scoreP2Display">0</div> <span class="name" id="player2NameDisplay">Pemain 2</span>
            </div>
        </div>
        <div id="gameIdDisplay">Game ID: ---</div>
        <div id="messages" class="hidden-info"></div>
        <div class="board-area">
            <div class="board-container" id="sosBoard"></div>
            <svg id="lineOverlay" class="line-overlay"></svg>
        </div>
        <div id="turnInfoDisplay">Menunggu permainan...</div>
        <div class="game-controls-bottom">
            <span class="label-sos">SOS</span>
            <div class="letter-buttons-bottom">
                <button class="letter-btn-bottom" data-letter="S">S</button>
                <button class="letter-btn-bottom" data-letter="O">O</button>
            </div>
        </div>
        <div class="admin-controls">
            <button id="resetGame">Reset Game</button>
            <button id="leaveGameBtn">Keluar Game</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4OChhfP7Y5TyK0O4eJrLPKRkc96IG8ykWIFoN9id6KslSv378EfaHfbZHEGSouOcq/exec"; // URL SUDAH DIMASUKKAN

        const sosBoardElement = document.getElementById('sosBoard');
        const lineOverlayElement = document.getElementById('lineOverlay');
        const scoreP1DisplayElement = document.getElementById('scoreP1Display');
        const scoreP2DisplayElement = document.getElementById('scoreP2Display');
        const turnInfoDisplayElement = document.getElementById('turnInfoDisplay');
        const player1NameDisplay = document.getElementById('player1NameDisplay');
        const player2NameDisplay = document.getElementById('player2NameDisplay');
        const gameIdDisplayElement = document.getElementById('gameIdDisplay');
        const messagesElement = document.getElementById('messages');

        const letterButtonsBottom = document.querySelectorAll('.letter-btn-bottom');
        const resetGameButton = document.getElementById('resetGame');
        const showAvailableGamesBtn = document.getElementById('showAvailableGamesBtn');
        const joinOrCreateGameBtn = document.getElementById('joinOrCreateGameBtn');
        const leaveGameBtn = document.getElementById('leaveGameBtn');
        const playerNameInput = document.getElementById('playerNameInput');
        const gameIdInput = document.getElementById('gameIdInput');
        const availableGamesDiv = document.getElementById('availableGames');

        const PLAYER1_TEXT_CLASS = 'player1-text';
        const PLAYER2_TEXT_CLASS = 'player2-text';
        const PLAYER1_LINE_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--player1-color-line').trim();
        const PLAYER2_LINE_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--player2-color-line').trim();

        const BOARD_SIZE = 7;
        let gameStateFromServer = {}; 
        let selectedLetter = 'S';

        let localPlayerName = "";
        let currentGameId = null;
        let localPlayerNumber = 0;
        let pollingInterval = null;
        let isMyTurn = false;

        let turnTimerInterval = null; // Untuk timer giliran di client
        const TURN_DURATION_SECONDS = 16; // <--- PERUBAHAN DI SINI (dari 7 ke 16)

        function showScreen(screenName) {
            document.getElementById('loginSection').style.display = (screenName === 'login') ? 'block' : 'none';
            document.getElementById('gameSection').style.display = (screenName === 'game') ? 'flex' : 'none';
            
            if (turnTimerInterval) clearInterval(turnTimerInterval); // Selalu bersihkan timer saat ganti screen

            if (screenName === 'login') {
                if(pollingInterval) clearInterval(pollingInterval);
                pollingInterval = null;
                if(availableGamesDiv) availableGamesDiv.style.display = 'none';
                if(gameIdDisplayElement) gameIdDisplayElement.textContent = 'Game ID: ---';
                if(messagesElement) messagesElement.classList.add('hidden-info');
            } else if (screenName === 'game') {
                requestAnimationFrame(positionLineOverlay); 
                if (gameIdDisplayElement && currentGameId) {
                    gameIdDisplayElement.textContent = `Game ID: ${currentGameId}`;
                } else if (gameIdDisplayElement) {
                    gameIdDisplayElement.textContent = `Game ID: ---`;
                }
                if (messagesElement) messagesElement.classList.add('hidden-info');
            }
        }

        function showMessage(text, isError = false) {
            if (!messagesElement) return;
            messagesElement.classList.remove('hidden-info');
            messagesElement.textContent = text;
            messagesElement.style.color = isError ? 'red' : 'green';
            if (text) {
                setTimeout(() => {
                    if(messagesElement.textContent === text) messagesElement.textContent = '';
                    messagesElement.classList.add('hidden-info');
                }, 5000);
            } else {
                messagesElement.classList.add('hidden-info');
            }
        }

        async function callAppsScript(action, payload = {}, method = 'POST') {
            const url = new URL(SCRIPT_URL);
            let response;
            const buttonsToDisable = [showAvailableGamesBtn, joinOrCreateGameBtn, leaveGameBtn, resetGameButton];
            buttonsToDisable.forEach(btn => { if (btn) btn.disabled = true; });
            // Tombol board dan letter akan di-disable/enable oleh updateUIFromGameState atau handleCellClick

            try {
                if (method === 'GET') {
                    url.searchParams.append('action', action);
                    for (const key in payload) {
                        url.searchParams.append(key, payload[key]);
                    }
                    response = await fetch(url);
                } else {
                    payload.action = action;
                    response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors', // Penting untuk Apps Script
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' } // Apps Script seringkali lebih suka text/plain untuk body JSON
                    });
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Network error: ${response.status}. ${errorText}`);
                }
                const data = await response.json();
                if (!data.success &&
                    action !== 'getGames' && 
                    !(action === 'getGameState' && data.error && data.error.includes("Game not found"))
                   ) {
                    throw new Error(data.error || `API call (${action}) failed without specific server error.`);
                }
                return data;
            } catch (error) {
                console.error(`Error in callAppsScript (${action}):`, error.message);
                // Jangan tampilkan pesan error untuk polling getGameState jika game tidak ditemukan dan interval masih ada
                // Kecuali jika itu bukan error "Game not found"
                if (!(action === 'getGameState' && pollingInterval && error.message.includes("Game not found"))) {
                     if (!(action === 'getGameState' && error.message.includes("Lock timed out"))) { // Jangan spam jika lock timeout di polling
                        showMessage(`Error: ${error.message}`, true);
                     }
                }
                throw error; // Tetap lempar error agar bisa ditangani oleh pemanggil jika perlu
            } finally {
                // Kembalikan state tombol login
                if (showAvailableGamesBtn) showAvailableGamesBtn.disabled = false;
                if (joinOrCreateGameBtn) joinOrCreateGameBtn.disabled = false;
                // State tombol game (reset, leave) akan diatur oleh updateUIFromGameState
            }
        }
        
        function setActiveLetterButton() {
            letterButtonsBottom.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.letter === selectedLetter) {
                    btn.classList.add('active');
                }
            });
        }

        function initLocalGameUI() {
            selectedLetter = 'S';
            setActiveLetterButton();
            clearLines();
            if(sosBoardElement) sosBoardElement.style.pointerEvents = 'auto';
            if(messagesElement) messagesElement.classList.add('hidden-info');
            if (gameIdDisplayElement && currentGameId) {
                gameIdDisplayElement.textContent = `Game ID: ${currentGameId}`;
            } else if (gameIdDisplayElement) {
                gameIdDisplayElement.textContent = `Game ID: ---`;
            }
            // gameStateFromServer akan diisi oleh updateUIFromGameState
        }

        function renderBoard(boardData, lastMoveDetails) {
            if (!sosBoardElement) return;
            sosBoardElement.innerHTML = '';
            sosBoardElement.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`;
            sosBoardElement.style.gridTemplateRows = `repeat(${BOARD_SIZE}, 1fr)`;

            const boardWidth = sosBoardElement.offsetWidth;
            let fontSizeForCell = (boardWidth / BOARD_SIZE) * 0.48;
            if (fontSizeForCell < 10) fontSizeForCell = 10;
            if (fontSizeForCell > 32) fontSizeForCell = 32;

            const prevHighlight = sosBoardElement.querySelector('.last-move-highlight');
            if (prevHighlight) prevHighlight.classList.remove('last-move-highlight');
            
            let currentLastScoringCell = null;
            // Highlight cell dari lastMoveDetails jika itu adalah 'move' dan bukan 'timeout'
            if (lastMoveDetails && lastMoveDetails.type === 'move' && lastMoveDetails.details && typeof lastMoveDetails.details.r !== 'undefined') {
                currentLastScoringCell = { r: lastMoveDetails.details.r, c: lastMoveDetails.details.c };
            }


            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('board-cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.style.fontSize = `${fontSizeForCell}px`;

                    if (boardData && boardData[r] && boardData[r][c]) {
                        cell.textContent = boardData[r][c].letter;
                        cell.classList.add(boardData[r][c].player === 1 ? PLAYER1_TEXT_CLASS : PLAYER2_TEXT_CLASS);
                        cell.classList.add('filled');
                        cell.style.cursor = 'default';
                    } else {
                        cell.style.cursor = isMyTurn ? 'pointer' : 'not-allowed';
                    }

                    if (currentLastScoringCell && currentLastScoringCell.r === r && currentLastScoringCell.c === c) {
                        cell.classList.add('last-move-highlight');
                    }

                    cell.addEventListener('click', handleCellClick);
                    sosBoardElement.appendChild(cell);
                }
            }
        }

        function positionLineOverlay() {
            if (!sosBoardElement || !lineOverlayElement) return;
            const boardRect = sosBoardElement.getBoundingClientRect();
            if (boardRect.width === 0 && boardRect.height === 0 && document.getElementById('gameSection').style.display !== 'flex') { return; }
            const boardAreaRect = sosBoardElement.parentElement.getBoundingClientRect();

            lineOverlayElement.style.position = 'absolute';
            lineOverlayElement.style.top = `${boardRect.top - boardAreaRect.top}px`;
            lineOverlayElement.style.left = `${boardRect.left - boardAreaRect.left}px`;
            lineOverlayElement.style.width = `${boardRect.width}px`;
            lineOverlayElement.style.height = `${boardRect.height}px`;
        }

        function drawSingleSOSLine(points, playerNum) {
            if (!sosBoardElement || !lineOverlayElement || !points || points.length !== 3) {
                return;
            }
            const s1_coords = points[0];
            const s2_coords = points[2];

            const boardRect = sosBoardElement.getBoundingClientRect();
            if (boardRect.width === 0 || boardRect.height === 0) {
                if (document.getElementById('gameSection').style.display === 'flex') {
                    requestAnimationFrame(() => {
                        drawSingleSOSLine(points, playerNum);
                    });
                }
                return;
            }

            const cellWidth = boardRect.width / BOARD_SIZE;
            const cellHeight = boardRect.height / BOARD_SIZE;

            const getCellCenter = (coord) => ({
                x: (coord.c + 0.5) * cellWidth,
                y: (coord.r + 0.5) * cellHeight
            });

            const startPoint = getCellCenter(s1_coords);
            const endPoint = getCellCenter(s2_coords);

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', startPoint.x.toFixed(2));
            line.setAttribute('y1', startPoint.y.toFixed(2));
            line.setAttribute('x2', endPoint.x.toFixed(2));
            line.setAttribute('y2', endPoint.y.toFixed(2));

            line.setAttribute('stroke', playerNum === 1 ? PLAYER1_LINE_COLOR : PLAYER2_LINE_COLOR);
            let strokeWidth = Math.max(4, Math.min(cellWidth, cellHeight) / 12); 
            line.setAttribute('stroke-width', strokeWidth.toFixed(2));
            line.setAttribute('stroke-linecap', 'round');

            lineOverlayElement.appendChild(line);
        }
        
        function getPlayerNameFromState(playerNum, gs) {
            if (playerNum === 1) return gs.player1 ? gs.player1.name : "Pemain 1";
            if (playerNum === 2) return gs.player2 ? gs.player2.name : (gs.gameStatus === "waiting_for_player2" ? "Menunggu..." : "Pemain 2");
            return "";
        }

        function updateUIFromGameState(gs) {
            const oldGameState = {...gameStateFromServer}; // Simpan state lama untuk perbandingan
            gameStateFromServer = {...gs};

            if (!gs || (!gs.gameId && (!gs.action || (gs.action !== 'getGames' && gs.action !== 'getGameState')))) {
                console.warn("Invalid or incomplete gameState for UI update:", gs);
                if (gs && gs.error === "Game not found" && currentGameId) {
                    showMessage("Game sesi ini tidak ditemukan atau telah berakhir.", true);
                    leaveCurrentGame(); // Kembali ke login
                }
                return;
            }
            
            currentGameId = gs.gameId || currentGameId;
            if (gameIdDisplayElement && currentGameId) {
                gameIdDisplayElement.textContent = `Game ID: ${currentGameId}`;
            } else if (gameIdDisplayElement) {
                gameIdDisplayElement.textContent = `Game ID: ---`;
            }

            if(gs.board && typeof gs.scores !== 'undefined') {
                player1NameDisplay.textContent = getPlayerNameFromState(1, gs);
                player2NameDisplay.textContent = getPlayerNameFromState(2, gs);
                scoreP1DisplayElement.textContent = gs.scores[1];
                scoreP2DisplayElement.textContent = gs.scores[2];
                
                isMyTurn = (localPlayerNumber === gs.currentPlayerNum) && !gs.gameOver && gs.gameStatus === "playing";

                renderBoard(gs.board, gs.lastEvent); // Kirim lastEvent untuk highlight potensial
                
                requestAnimationFrame(() => { 
                    positionLineOverlay();     
                    clearLines();               
                    if (gs.sosLines && gs.sosLines.length > 0) { 
                        gs.sosLines.forEach(sos => drawSingleSOSLine(sos.points, sos.playerNum));
                    }
                });
            }

            let turnText = "";
            let turnColor = 'var(--vs-text-color)';
            let turnNotification = "";

            // Cek apakah ada event timeout baru
            if (gs.lastEvent && gs.lastEvent.timestamp > (oldGameState.lastEvent?.timestamp || 0)) {
                if (gs.lastEvent.type === "timeout") {
                    const timedOutPlayerName = getPlayerNameFromState(gs.lastEvent.player, gs);
                    if (timedOutPlayerName) {
                         turnNotification = `${timedOutPlayerName} kehabisan waktu. `;
                    }
                } else if (gs.lastEvent.type === "reset" && gs.lastEvent.player === localPlayerName) {
                    showMessage("Game direset oleh Anda.", false);
                } else if (gs.lastEvent.type === "reset" && gs.lastEvent.player !== localPlayerName) {
                     showMessage(`Game direset oleh ${gs.lastEvent.player || 'pemain lain'}.`, false);
                }
            }


            if (gs.gameOver) {
                turnText = gs.winner === "Draw" ? "Permainan SERI!" : `${getPlayerNameFromState(gs.winnerPlayerNum, gs)} MENANG!`; // Asumsi gs.winnerPlayerNum ada jika bukan Draw
                turnColor = gs.winner === "Draw" ? 'var(--vs-text-color)' : (gs.winnerPlayerNum === 1 ? 'var(--player1-color-text)' : 'var(--player2-color-text)');
                if(sosBoardElement) sosBoardElement.style.pointerEvents = 'none';
                if(pollingInterval) clearInterval(pollingInterval);
                pollingInterval = null;
                if(turnTimerInterval) clearInterval(turnTimerInterval); // Hentikan timer giliran
            } else if (gs.gameStatus === "waiting_for_player2") {
                turnText = "Menunggu Pemain 2 bergabung...";
                if(sosBoardElement) sosBoardElement.style.pointerEvents = 'none';
                if(turnTimerInterval) clearInterval(turnTimerInterval);
            } else if(gs.gameStatus === "playing") {
                const currentPlayerDetails = gs.currentPlayerNum === 1 ? gs.player1 : gs.player2;
                turnText = `Giliran: ${currentPlayerDetails ? currentPlayerDetails.name : ('Pemain ' + gs.currentPlayerNum)}`;
                turnColor = gs.currentPlayerNum === 1 ? 'var(--player1-color-text)' : 'var(--player2-color-text)';
                if(sosBoardElement) sosBoardElement.style.pointerEvents = isMyTurn ? 'auto' : 'none';
                letterButtonsBottom.forEach(btn => btn.disabled = !isMyTurn);

                // Setup timer jika giliran pemain ini dan game sedang berjalan
                if (turnTimerInterval) clearInterval(turnTimerInterval);
                if (isMyTurn && gs.turnStartTime) {
                    const serverTurnStartTime = gs.turnStartTime;
                    const baseTurnTextForTimer = turnNotification + turnText;

                    const updateTimerDisplay = () => {
                        const now = new Date().getTime();
                        const elapsedMs = now - serverTurnStartTime;
                        const remainingSeconds = Math.max(0, Math.ceil((TURN_DURATION_SECONDS * 1000 - elapsedMs) / 1000));
                        
                        turnInfoDisplayElement.textContent = `${baseTurnTextForTimer} (Sisa waktu: ${remainingSeconds}s)`;
                        turnInfoDisplayElement.style.color = turnColor;


                        if (remainingSeconds <= 0) {
                            clearInterval(turnTimerInterval);
                            // Server akan menangani timeout, polling akan mengambil state baru
                            // Bisa tambahkan visual feedback sementara jika diinginkan
                            // turnInfoDisplayElement.textContent = `${baseTurnTextForTimer} (Waktu Habis!)`;
                        }
                    };
                    updateTimerDisplay(); // Panggil sekali untuk tampilan awal
                    turnTimerInterval = setInterval(updateTimerDisplay, 1000);
                } else {
                     turnInfoDisplayElement.textContent = turnNotification + turnText;
                     turnInfoDisplayElement.style.color = turnColor;
                }

            } else {
                turnText = "Menunggu permainan...";
                if(turnTimerInterval) clearInterval(turnTimerInterval);
                turnInfoDisplayElement.textContent = turnNotification + turnText;
                turnInfoDisplayElement.style.color = turnColor;
            }
            
            // Jika tidak ada timer aktif, pastikan teks utama tetap ada
            if (!isMyTurn || gs.gameOver || gs.gameStatus !== "playing") {
                 turnInfoDisplayElement.textContent = turnNotification + turnText;
                 turnInfoDisplayElement.style.color = turnColor;
            }


            if(resetGameButton) resetGameButton.disabled = !(localPlayerNumber === 1 || gs.gameOver);
            if(leaveGameBtn) leaveGameBtn.disabled = (!currentGameId && !gs.gameOver && gs.gameStatus !== "playing" && gs.gameStatus !== "waiting_for_player2" );
        }


        async function handleJoinOrCreateGame() {
            localPlayerName = playerNameInput.value.trim();
            if (!localPlayerName) {
                showMessage("Masukkan Nama Anda!", true);
                playerNameInput.focus();
                return;
            }
            const gameIdToJoin = gameIdInput.value.trim().toUpperCase();
            try {
                let gs;
                if (gameIdToJoin) {
                    showMessage("Mencoba bergabung ke game...", false);
                    gs = await callAppsScript('joinGame', { gameId: gameIdToJoin, playerName: localPlayerName });
                } else {
                    showMessage("Membuat game baru...", false);
                    gs = await callAppsScript('createGame', { playerName: localPlayerName });
                }
                
                if (!gs.success) { // Jika server mengembalikan success:false secara eksplisit
                    showMessage(gs.error || "Gagal memproses permintaan.", true);
                    return;
                }

                currentGameId = gs.gameId;
                localPlayerNumber = gs.playerNum;
                // gameStateFromServer akan diisi oleh updateUIFromGameState

                initLocalGameUI();
                updateUIFromGameState(gs); // Panggil ini untuk setup UI awal game
                showScreen('game');
                if(pollingInterval) clearInterval(pollingInterval);
                pollingInterval = setInterval(fetchCurrentGameState, 2500); // Polling lebih cepat sedikit

            } catch (error) {
                console.error("Error in Join/Create: ", error.message);
                // showMessage sudah ditangani oleh callAppsScript
            }
        }

        async function fetchCurrentGameState() {
            if (!currentGameId || !pollingInterval) return;
            let originalLoginButtonStates = {};
             // Hanya disable tombol login jika kita di halaman login, untuk menghindari konflik
            if (document.getElementById('loginSection').style.display === 'block'){
                if (showAvailableGamesBtn) {originalLoginButtonStates.show = showAvailableGamesBtn.disabled; showAvailableGamesBtn.disabled = true;}
                if (joinOrCreateGameBtn) {originalLoginButtonStates.join = joinOrCreateGameBtn.disabled; joinOrCreateGameBtn.disabled = true;}
            }
            
            try {
                // Untuk getGameState, kita tidak perlu disable tombol game secara global di callAppsScript
                // Karena updateUIFromGameState akan mengaturnya.
                // Untuk itu, kita panggil fetch langsung atau modifikasi callAppsScript untuk GET
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'getGameState');
                url.searchParams.append('gameId', currentGameId);
                const response = await fetch(url);
                if (!response.ok) {
                     const errorText = await response.text();
                     // Jangan spam console jika hanya lock timeout
                     if (!errorText.includes("Lock timed out")) {
                        console.error(`Network error on polling: ${response.status}. ${errorText}`);
                     }
                     // Jika game tidak ditemukan, tangani di bawah
                     if (response.status === 404 || (errorText && errorText.includes("Game not found"))) {
                         throw new Error("Game not found");
                     }
                     return; // Jangan proses lebih lanjut jika ada error jaringan lain
                }
                const gs = await response.json();

                if (pollingInterval && gs.success) {
                    updateUIFromGameState(gs);
                } else if (pollingInterval && (!gs.success && gs.error && gs.error.includes("Game not found"))){
                    showMessage("Sesi game tidak ditemukan atau telah berakhir.", true);
                    leaveCurrentGame(); // Kembali ke login
                }
            } catch (error) {
                 if (error.message.includes("Game not found") && pollingInterval) {
                    showMessage("Sesi game tidak ditemukan atau telah berakhir.", true);
                    leaveCurrentGame();
                 } else if (!error.message.includes("Lock timed out")) { // Jangan log error lock timeout berlebihan
                    console.error("Error fetching game state:", error.message);
                 }
            } finally {
                 if (document.getElementById('loginSection').style.display === 'block'){
                    if (showAvailableGamesBtn && typeof originalLoginButtonStates.show !== 'undefined') showAvailableGamesBtn.disabled = originalLoginButtonStates.show;
                    if (joinOrCreateGameBtn && typeof originalLoginButtonStates.join !== 'undefined') joinOrCreateGameBtn.disabled = originalLoginButtonStates.join;
                 }
            }
        }

        async function handleCellClick(event) {
            if (!isMyTurn || !currentGameId) return;
            const targetCell = event.target.closest('.board-cell');
            if (!targetCell || targetCell.classList.contains('filled')) return;

            const row = parseInt(targetCell.dataset.row);
            const col = parseInt(targetCell.dataset.col);

            if(sosBoardElement) sosBoardElement.style.pointerEvents = 'none'; // Disable board sementara
            letterButtonsBottom.forEach(btn => btn.disabled = true); // Disable tombol S/O
            if (turnTimerInterval) clearInterval(turnTimerInterval); // Hentikan timer saat move dikirim

            try {
                const gs = await callAppsScript('makeMove', {
                    gameId: currentGameId,
                    playerName: localPlayerName, // Server akan validasi playerNum dari playerName ini
                    move: { r: row, c: col, letter: selectedLetter }
                });
                 if (!gs.success) { // Jika server mengembalikan success:false secara eksplisit
                    showMessage(gs.error || "Gagal melakukan langkah.", true);
                    // Ambil state terbaru karena mungkin move ditolak server
                    fetchCurrentGameState(); 
                    return;
                }
                updateUIFromGameState(gs); // Server akan mengembalikan state baru, termasuk potensi giliran baru & timer baru
            } catch (error) {
                // Jika error, coba fetch state terbaru untuk sinkronisasi
                // showMessage sudah ditangani oleh callAppsScript
                fetchCurrentGameState(); 
            }
            // Enable/disable board dan tombol akan diurus oleh updateUIFromGameState berdasarkan state baru
        }

        async function handleResetGame() {
            if (!currentGameId) return;
            if (!confirm("Yakin ingin mereset game ini? (Hanya Pemain 1 atau setelah game berakhir)")) return;
            
            if (turnTimerInterval) clearInterval(turnTimerInterval);

            try {
                const gs = await callAppsScript('resetGame', { gameId: currentGameId, playerName: localPlayerName });
                if (!gs.success) {
                     showMessage(gs.error || "Gagal mereset game.", true);
                     fetchCurrentGameState(); // Sync
                     return;
                }
                // updateUIFromGameState akan menangani pesan reset jika dari pemain lain.
                // Jika reset oleh diri sendiri, pesan akan ditampilkan oleh logic lastEvent di updateUI
                updateUIFromGameState(gs);
                // Polling akan di-restart oleh updateUIFromGameState jika game aktif kembali
                 if (pollingInterval) clearInterval(pollingInterval);
                 if (!gs.gameOver && gs.gameStatus === "playing") {
                    pollingInterval = setInterval(fetchCurrentGameState, 2500);
                 }

            } catch (error) { 
                fetchCurrentGameState(); // Sync
            }
        }

        function leaveCurrentGame() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = null;
            if (turnTimerInterval) clearInterval(turnTimerInterval);
            turnTimerInterval = null;

            const oldGameId = currentGameId;
            currentGameId = null;
            localPlayerNumber = 0;
            isMyTurn = false;
            gameStateFromServer = {}; 

            showScreen('login'); // Kembali ke layar login
            
            if(gameIdInput) gameIdInput.value = "";
            // Pesan default sudah diatur di showScreen atau initLocalGameUI, tapi bisa tambahkan pesan keluar
            // showMessage akan membersihkan dirinya sendiri, jadi tidak perlu clear manual di sini.
            // State UI game (score, nama player, board) akan direset saat game baru dimulai atau UI dirender ulang.
             if(turnInfoDisplayElement) turnInfoDisplayElement.textContent = "Menunggu permainan...";
             if(scoreP1DisplayElement) scoreP1DisplayElement.textContent = "0";
             if(scoreP2DisplayElement) scoreP2DisplayElement.textContent = "0";
             if(player1NameDisplay) player1NameDisplay.textContent = "Pemain 1";
             if(player2NameDisplay) player2NameDisplay.textContent = "Pemain 2";
             if(sosBoardElement) sosBoardElement.innerHTML = "";
             clearLines();
            showMessage(`Anda telah keluar dari game ${oldGameId || ""}.`);
        }


        async function fetchAvailableGames() {
            if(!availableGamesDiv) return;
            availableGamesDiv.innerHTML = '<p><i>Memuat daftar game...</i></p>';
            try {
                // Untuk getGames, tidak perlu payload spesifik di body jika pakai GET
                const data = await callAppsScript('getGames', {}, 'GET'); 
                if (data.success && data.games && data.games.length > 0) {
                    let gameListHtml = '<ul>';
                    data.games.forEach(g => {
                        let joinButtonHtml = '';
                        if (g.status === 'waiting_for_player2' && !g.player2) {
                            joinButtonHtml = `<button class="join-lobby-btn" data-gameid="${g.gameId}">Gabung</button>`;
                        }
                        const p1Name = g.player1Name || g.player1 || '?'; // Kompatibilitas dengan struktur data game
                        const p2Name = g.player2Name || g.player2 || (g.status === 'waiting_for_player2' ? 'Kosong' : '?');
                        gameListHtml += `<li><span>ID: ${g.gameId} (P1: ${p1Name}, P2: ${p2Name}) - ${g.statusDisplay || g.status}</span> ${joinButtonHtml}</li>`;
                    });
                    gameListHtml += '</ul>';
                    availableGamesDiv.innerHTML = gameListHtml;

                    document.querySelectorAll('.join-lobby-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const gameIdFromLobby = e.target.dataset.gameid;
                            if(gameIdInput) gameIdInput.value = gameIdFromLobby;
                            localPlayerName = playerNameInput.value.trim(); // Pastikan nama pemain sudah ada
                            if (!localPlayerName) {
                                showMessage("Masukkan Nama Anda terlebih dahulu untuk bergabung dari lobi!", true);
                                playerNameInput.focus();
                                return;
                            }
                            handleJoinOrCreateGame(); // Panggil fungsi join yang sudah ada
                        });
                    });

                } else {
                    availableGamesDiv.innerHTML = '<p><i>Tidak ada game tersedia. Buat yang baru!</i></p>';
                }
            } catch (error) {
                if(availableGamesDiv) availableGamesDiv.innerHTML = `<p><i>Gagal memuat game. Coba lagi nanti.</i></p>`; // Pesan error lebih generik
                console.error("Error fetching available games:", error.message);
            }
        }
        
        function clearLines() {
            if (lineOverlayElement) lineOverlayElement.innerHTML = '';
        }

        letterButtonsBottom.forEach(button => {
            button.addEventListener('click', () => {
                if (!isMyTurn) return; // Seharusnya tombol sudah disabled, tapi sebagai pengaman
                selectedLetter = button.dataset.letter;
                setActiveLetterButton();
            });
        });

        if(showAvailableGamesBtn) showAvailableGamesBtn.addEventListener('click', () => {
            if (availableGamesDiv.style.display === 'none' || availableGamesDiv.style.display === '') {
                availableGamesDiv.style.display = 'block';
                fetchAvailableGames();
            } else {
                availableGamesDiv.style.display = 'none';
            }
        });
        if(joinOrCreateGameBtn) joinOrCreateGameBtn.addEventListener('click', handleJoinOrCreateGame);
        if(resetGameButton) resetGameButton.addEventListener('click', handleResetGame);
        if(leaveGameBtn) leaveGameBtn.addEventListener('click', leaveCurrentGame);


        document.addEventListener('DOMContentLoaded', () => {
            showScreen('login');
            setActiveLetterButton(); // Panggil sekali di awal untuk set default (S)
            window.addEventListener('resize', () => {
                if (document.getElementById('gameSection').style.display === 'flex') {
                    requestAnimationFrame(() => {
                        positionLineOverlay();
                        if(currentGameId && gameStateFromServer.board && gameStateFromServer.board.length > 0) {
                            // renderBoard dipanggil oleh updateUI, tidak perlu panggil ulang di sini kecuali ada logika khusus resize
                            // Jika hanya reposisi garis, cukup panggil itu.
                            clearLines();
                            if (gameStateFromServer.sosLines && gameStateFromServer.sosLines.length > 0) {
                                gameStateFromServer.sosLines.forEach(sos => drawSingleSOSLine(sos.points, sos.playerNum));
                            }
                        }
                    });
                }
            });
             // Cek apakah ada nama pemain tersimpan di localStorage
            const savedPlayerName = localStorage.getItem('sosPlayerName');
            if (savedPlayerName && playerNameInput) {
                playerNameInput.value = savedPlayerName;
            }
            // Simpan nama pemain saat diubah
            if (playerNameInput) {
                playerNameInput.addEventListener('change', () => {
                    localStorage.setItem('sosPlayerName', playerNameInput.value.trim());
                });
            }
        });
    </script>
</body>
</html>
